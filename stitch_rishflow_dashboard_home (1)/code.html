<!DOCTYPE html>
<html class="dark" lang="en"><head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>RishFlow Grid Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&amp;family=Outfit:wght@400;600;700&amp;display=swap" rel="stylesheet"/>
<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        primary: "#0ea5e9",
                        "background-dark": "#0c1a25",
                        "teal-ocean": "#0d9488",
                        "deep-sea": "#082f49",
                    },
                    fontFamily: {
                        display: ["Outfit", "sans-serif"],
                        sans: ["Inter", "sans-serif"],
                    },
                    borderRadius: {
                        DEFAULT: "0.75rem",
                        'xl': '1.25rem',
                    },
                },
            },
        };
    </script>
<style type="text/tailwindcss">
        @layer components {
            .glass {
                @apply bg-white/5 backdrop-blur-md border border-white/10;
            }
            .ocean-gradient {
                background: linear-gradient(135deg, #083344 0%, #0c4a6e 50%, #0d9488 100%);
            }
            .custom-scrollbar::-webkit-scrollbar {
                width: 4px;
            }
            .custom-scrollbar::-webkit-scrollbar-track {
                background: rgba(0, 0, 0, 0.05);
            }
            .custom-scrollbar::-webkit-scrollbar-thumb {
                background: rgba(255, 255, 255, 0.1);
                border-radius: 10px;
            }
        }
    </style>
</head>
<body class="bg-background-dark text-slate-100 font-sans h-screen flex flex-col overflow-hidden">
<div class="fixed inset-0 z-[-1] ocean-gradient opacity-40"></div>
<header class="h-20 glass flex items-center px-6 gap-6 z-10">
<div class="flex items-center gap-3 min-w-[180px]">
<div class="relative w-10 h-10 rounded-lg overflow-hidden border border-primary/30">
<img alt="RishFlow Logo" class="object-cover w-full h-full" src="../Logo.jpg"/>
</div>
<div>
<h1 class="font-display font-bold text-lg tracking-tight text-primary leading-none">RishFlow</h1>
<p class="text-[10px] uppercase tracking-widest font-semibold opacity-50">Grid Engine</p>
</div>
</div>
<div class="flex-1 flex items-center gap-4">
<div class="flex-1 flex gap-3">
<div class="relative flex-1 max-w-sm">
<span class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-primary text-lg">folder_open</span>
<input id="sourceFolder" class="w-full pl-10 pr-4 py-2 bg-white/5 border border-white/10 rounded-lg text-sm focus:ring-primary focus:border-primary placeholder:text-slate-500" placeholder="Source Folder" type="text" value=""/>
</div>
<button onclick="browseSource()" class="px-3 py-2 bg-primary/20 hover:bg-primary/30 border border-primary/50 text-primary rounded-lg text-xs font-semibold transition-colors flex items-center gap-1">
<span class="material-symbols-outlined text-sm">folder</span>
Browse
</button>
<div class="relative flex-1 max-w-sm">
<span class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-teal-ocean text-lg">folder_special</span>
<input id="destFolder" class="w-full pl-10 pr-4 py-2 bg-white/5 border border-white/10 rounded-lg text-sm focus:ring-primary focus:border-primary placeholder:text-slate-500" placeholder="Destination" type="text" value=""/>
</div>
<button onclick="browseDest()" class="px-3 py-2 bg-teal-ocean/20 hover:bg-teal-ocean/30 border border-teal-ocean/50 text-teal-ocean rounded-lg text-xs font-semibold transition-colors flex items-center gap-1">
<span class="material-symbols-outlined text-sm">folder</span>
Browse
</button>
</div>
<div class="h-8 w-px bg-white/10 mx-2"></div>
<div class="flex items-center gap-2">
<span class="material-symbols-outlined text-amber-500 text-lg">sort</span>
<select id="sortMode" class="bg-white/10 border border-white/20 rounded-lg text-xs py-2 pr-10 text-slate-100 focus:ring-2 focus:ring-primary focus:border-primary hover:bg-white/15">
<option class="bg-slate-800 text-white">File Extension</option>
<option class="bg-slate-800 text-white">Date Modified</option>
<option class="bg-slate-800 text-white">Size Category</option>
<option class="bg-slate-800 text-white">AI-based Content</option>
</select>
</div>

<!-- AI search -->
<div class="ml-4 flex items-center gap-2">
<input id="aiSearchInput" placeholder="Search folder (AI)..." class="w-60 pl-3 py-2 bg-white/5 border border-white/10 rounded-lg text-sm text-slate-100" type="text">
<button onclick="aiSearch()" class="px-3 py-2 bg-amber-500/20 hover:bg-amber-500/30 text-amber-300 rounded-lg text-xs font-semibold">AI Search</button>
</div>
</div>
<div class="flex items-center gap-2">
    <button id="undoBtn" class="mr-3 bg-white/10 hover:bg-white/20 text-white font-medium py-2 px-3 rounded-lg text-sm" onclick="undoOrganizing()">Undo</button>
    <button id="startBtn" class="bg-primary hover:bg-sky-500 text-white font-display font-bold py-2.5 px-6 rounded-lg flex items-center gap-2 shadow-lg shadow-primary/20 transition-all active:scale-95 whitespace-nowrap" onclick="startOrganizing()">
<span class="material-symbols-outlined text-xl">rocket_launch</span>
            START ORGANIZING
        </button>
</div>
</header>
<main class="flex-1 flex overflow-hidden p-4 gap-4">
<div class="flex-1 flex flex-col gap-4">
<div class="flex-1 glass rounded-xl overflow-hidden flex flex-col">
<div class="p-3 border-b border-white/10 flex items-center justify-between bg-white/5">
<div class="flex items-center gap-2">
<span class="material-symbols-outlined text-primary text-lg">grid_view</span>
<h2 class="text-xs font-semibold uppercase tracking-widest">Active File Queue</h2>
</div>
<div class="flex gap-4 text-[10px] font-medium opacity-60 uppercase tracking-tighter">
<span id="itemsCount">Items: 0</span>
<span id="sizeTotal">Size: 0 B</span>
</div>
</div>
<div class="flex-1 p-4 grid grid-cols-4 lg:grid-cols-6 gap-3 overflow-y-auto custom-scrollbar content-start" id="fileQueue">
<div class="aspect-square glass rounded-lg flex flex-col items-center justify-center gap-2 border-white/5 hover:border-primary/50 cursor-pointer group transition-colors" onclick="selectFile(this, 'report_q4.pdf', 'document')">
<span class="material-symbols-outlined text-3xl text-red-400 group-hover:scale-110 transition-transform">picture_as_pdf</span>
<span class="text-[10px] opacity-70 truncate w-full px-2 text-center">report_q4.pdf</span>
</div>
<div class="aspect-square glass rounded-lg flex flex-col items-center justify-center gap-2 border-white/5 hover:border-primary/50 cursor-pointer group transition-colors" onclick="selectFile(this, 'vacation_01.jpg', 'image')">
<span class="material-symbols-outlined text-3xl text-blue-400">image</span>
<span class="text-[10px] opacity-70 truncate w-full px-2 text-center">vacation_01.jpg</span>
</div>
<div class="aspect-square glass rounded-lg flex flex-col items-center justify-center gap-2 border-white/5 hover:border-primary/50 cursor-pointer group transition-colors" onclick="selectFile(this, 'resume.docx', 'document')">
<span class="material-symbols-outlined text-3xl text-emerald-400">description</span>
<span class="text-[10px] opacity-70 truncate w-full px-2 text-center">resume.docx</span>
</div>
<div class="aspect-square glass rounded-lg flex flex-col items-center justify-center gap-2 border-white/5 hover:border-primary/50 cursor-pointer group transition-colors" onclick="selectFile(this, 'intro_vid.mp4', 'video')">
<span class="material-symbols-outlined text-3xl text-amber-400">video_library</span>
<span class="text-[10px] opacity-70 truncate w-full px-2 text-center">intro_vid.mp4</span>
</div>
<div class="aspect-square glass rounded-lg flex flex-col items-center justify-center gap-2 border-white/5 hover:border-primary/50 cursor-pointer group transition-colors" onclick="selectFile(this, 'archive.zip', 'archive')">
<span class="material-symbols-outlined text-3xl text-slate-400">folder_zip</span>
<span class="text-[10px] opacity-70 truncate w-full px-2 text-center">archive.zip</span>
</div>
<div class="aspect-square glass rounded-lg flex flex-col items-center justify-center gap-2 border-white/5 hover:border-primary/50 cursor-pointer group transition-colors opacity-50">
<span class="material-symbols-outlined text-3xl">add</span>
<span class="text-[10px] opacity-70">Add Files</span>
</div>
</div>
</div>
<div class="h-64 glass rounded-xl flex flex-col overflow-hidden">
<div class="px-4 py-2 border-b border-white/10 flex items-center justify-between bg-white/5">
<div class="flex items-center gap-2">
<span class="material-symbols-outlined text-primary text-lg">visibility</span>
<h2 class="text-xs font-semibold uppercase tracking-widest">File Preview</h2>
</div>
<div class="flex items-center gap-3">
<button class="hover:text-primary transition-colors" onclick="openFullscreenPreview()"><span class="material-symbols-outlined text-sm">fullscreen</span></button>
<button class="hover:text-primary transition-colors"><span class="material-symbols-outlined text-sm">download</span></button>
</div>
</div>
<div class="flex-1 flex items-center justify-center p-6" id="previewArea">
<div class="w-full h-full border-2 border-dashed border-white/10 rounded-xl flex flex-col items-center justify-center gap-3 opacity-40">
<span class="material-symbols-outlined text-5xl">insert_drive_file</span>
<div class="text-center">
<p class="text-sm font-medium">No file selected</p>
<p class="text-[10px]">Preview window updates on item click</p>
</div>
</div>
</div>
</div>
</div>
<aside class="w-80 glass rounded-xl flex flex-col overflow-hidden border-l border-white/10">
<div class="p-4 border-b border-white/10 flex items-center gap-2 bg-white/5">
<span class="material-symbols-outlined text-teal-ocean text-lg">monitoring</span>
<h2 class="text-xs font-semibold uppercase tracking-widest">Real-time Activity</h2>
</div>
<div class="flex-1 overflow-y-auto p-4 custom-scrollbar">
<div id="activityList" class="space-y-4 font-mono text-[11px]">
<div class="flex gap-2 text-slate-400">
<span class="text-primary/70">[14:45]</span>
<span class="flex-1">System ready. Waiting for user input.</span>
</div>
<!-- Activity log placeholders are empty until user actions occur -->
<div class="flex gap-2 text-slate-400 animate-pulse">
<span class="text-primary/70">[14:48]</span>
<span class="flex-1">Idle... Pulse check active.</span>
</div>
</div>
</div>
<div class="p-4 border-t border-white/10 flex flex-col gap-2">
<button class="w-full py-2 bg-white/5 hover:bg-white/10 rounded-lg text-xs font-medium flex items-center justify-center gap-2 transition-all">
<span class="material-symbols-outlined text-sm">history</span>
                    Clear Logs
                </button>
</div>
</aside>
</main>
<footer class="h-12 glass flex items-center justify-between px-6 z-10 border-t border-white/10">
<div class="flex items-center gap-6 text-[10px] font-medium opacity-60 uppercase tracking-widest">
<div class="flex items-center gap-2">
<span class="h-2 w-2 rounded-full bg-emerald-500 animate-pulse"></span>
                Engine: v2.0-Grid-Ready
            </div>
<div>Storage: 78% Free</div>
</div>
<div class="flex items-center gap-4">
<span class="text-[10px] font-semibold opacity-50 uppercase">Theme Mode:</span>
<div class="flex bg-black/30 p-1 rounded-lg gap-1 border border-white/10">
<button class="px-3 py-1 text-[10px] font-bold rounded-md bg-primary text-white shadow-sm" onclick="setTheme('ocean')">OCEAN</button>
<button class="px-3 py-1 text-[10px] font-bold rounded-md hover:bg-white/5 text-slate-400" onclick="setTheme('deep')">DEEP</button>
<button class="px-3 py-1 text-[10px] font-bold rounded-md hover:bg-white/5 text-slate-400" onclick="setTheme('sunset')">SUNSET</button>
</div>
</div>
</footer>
<script>
        let selectedFile = null;
        
        function setTheme(theme) {
            // Visual demo of theme toggle
            const root = document.documentElement;
            const bgOverlay = document.querySelector('.ocean-gradient');
            if (theme === 'sunset') {
                bgOverlay.style.background = 'linear-gradient(135deg, #f43f5e 0%, #f97316 100%)';
            } else if (theme === 'deep') {
                bgOverlay.style.background = 'linear-gradient(135deg, #020617 0%, #0f172a 100%)';
            } else {
                bgOverlay.style.background = 'linear-gradient(135deg, #083344 0%, #0c4a6e 50%, #0d9488 100%)';
            }
            try { localStorage.setItem('rishflow_theme', theme); } catch (e) { /* ignore */ }
        }
        
        async function browseSource() {
            try {
                const folderPath = await window.pywebview.api.browse_folder('Select Source Folder');
                if (folderPath) {
                    document.getElementById('sourceFolder').value = folderPath;
                    // After selecting a source, scan it and populate the queue
                    try {
                        const resp = await window.pywebview.api.scan_source(folderPath);
                        const files = Array.isArray(resp) ? resp : (resp && resp.files) ? resp.files : [];
                        populateQueue(files);

                        // Fetch and update aggregated folder stats
                        try {
                            const stats = await window.pywebview.api.get_folder_stats(folderPath);
                            updateStatsPanel(stats);
                        } catch (statErr) {
                            console.warn('Error fetching folder stats:', statErr);
                        }
                    } catch (scanErr) {
                        console.error('Error scanning source:', scanErr);
                    }
                }
            } catch (error) {
                console.error('Error selecting folder:', error);
                alert('Error selecting folder');
            }
        }
        
        async function browseDest() {
            try {
                const folderPath = await window.pywebview.api.browse_folder('Select Destination Folder');
                if (folderPath) {
                    document.getElementById('destFolder').value = folderPath;
                }
            } catch (error) {
                console.error('Error selecting folder:', error);
                alert('Error selecting folder');
            }
        }

        // Populate the file queue UI from backend scan results
        function populateQueue(files) {
            const queue = document.getElementById('fileQueue');
            queue.innerHTML = '';
            if (!files || files.length === 0) {
                queue.innerHTML = '<div class="text-sm text-slate-400">No files found in the selected folder.</div>';
                return;
            }

            files.forEach(f => {
                const tile = document.createElement('div');
                tile.className = 'aspect-square glass rounded-lg flex flex-col items-center justify-center gap-2 border-white/5 hover:border-primary/50 cursor-pointer group transition-colors';
                tile.setAttribute('data-path', f.path);
                tile.onclick = () => {
                    // mark selection visually and set selectedFile
                    document.querySelectorAll('#fileQueue > div').forEach(el => el.classList.remove('border-primary','bg-primary/10'));
                    tile.classList.add('border-primary','bg-primary/10');
                    selectedFile = { name: f.name, type: f.type, path: f.path };
                    updatePreview(f.name, f.type);
                };

                const icon = document.createElement('span');
                icon.className = 'material-symbols-outlined text-3xl text-slate-400';
                // choose icon by type
                const map = { document: 'picture_as_pdf', image: 'image', video: 'video_library', archive: 'folder_zip' };
                icon.textContent = map[f.type] || 'insert_drive_file';

                const label = document.createElement('span');
                label.className = 'text-[10px] opacity-70 truncate w-full px-2 text-center';
                label.textContent = f.name;

                tile.appendChild(icon);
                tile.appendChild(label);
                queue.appendChild(tile);
            });
        }

        async function undoOrganizing() {
            try {
                const res = await window.pywebview.api.revert_last();
                if (res && (res.count || res.count === 0)) {
                    const n = res.count || 0;
                    if (n > 0) alert('Reverted ' + n + ' files');
                    else alert('Nothing to revert');
                    // refresh the queue from source if available
                    const src = document.getElementById('sourceFolder').value.trim();
                    if (src) {
                        const resp = await window.pywebview.api.scan_source(src);
                        const files = Array.isArray(resp) ? resp : (resp && resp.files) ? resp.files : [];
                        populateQueue(files);
                    }
                    // also refresh activity log
                    const logs = await window.pywebview.api.get_logs();
                    updateActivity(logs);
                } else {
                    alert('Nothing to revert');
                }
            } catch (err) {
                console.error('Undo error:', err);
                alert('Error during undo: ' + err);
            }
        }
        
        function selectFile(element, fileName, fileType) {
            // Remove previous selection
            document.querySelectorAll('#fileQueue > div').forEach(el => {
                el.classList.remove('border-primary', 'bg-primary/10');
            });
            
            // Add selection styling
            element.classList.add('border-primary', 'bg-primary/10');
            
            selectedFile = { name: fileName, type: fileType };
            updatePreview(fileName, fileType);
        }
        
        function updatePreview(fileName, fileType) {
            const previewArea = document.getElementById('previewArea');
            let previewContent = '';
            
            const iconMap = {
                'document': { icon: 'picture_as_pdf', color: 'text-red-400' },
                'image': { icon: 'image', color: 'text-blue-400' },
                'video': { icon: 'video_library', color: 'text-amber-400' },
                'archive': { icon: 'folder_zip', color: 'text-slate-400' }
            };
            
            const fileInfo = iconMap[fileType] || { icon: 'insert_drive_file', color: 'text-slate-400' };
            
            previewContent = `
                <div class="w-full h-full flex flex-col items-center justify-center gap-4">
                    <span class="material-symbols-outlined text-7xl ${fileInfo.color}">${fileInfo.icon}</span>
                    <div class="text-center">
                        <p class="text-lg font-semibold text-white">${fileName}</p>
                        <p class="text-xs text-slate-400 mt-1">Type: ${fileType}</p>
                        <p class="text-xs text-slate-500 mt-3">Ready to organize</p>
                    </div>
                </div>
            `;
            
            previewArea.innerHTML = previewContent;
        }
        
        function humanSize(bytes) {
            if (!bytes && bytes !== 0) return '0 B';
            const units = ['B','KB','MB','GB','TB'];
            let b = Number(bytes);
            let i = 0;
            while (b >= 1024 && i < units.length - 1) { b /= 1024; i++; }
            // show 2 decimals for <10 with units beyond bytes, otherwise 1
            const decimals = (b < 10 && i > 0) ? 2 : 1;
            return b.toFixed(decimals) + ' ' + units[i];
        }

        function updateStatsPanel(stats) {
            if (!stats || stats.error) return;
            const itemsEl = document.getElementById('itemsCount');
            const sizeEl = document.getElementById('sizeTotal');
            if (itemsEl) itemsEl.textContent = 'Items: ' + (stats.total_files || 0);
            if (sizeEl) sizeEl.textContent = 'Size: ' + humanSize(stats.total_size || 0);

            // Optionally show top largest in activity pane
            const activity = document.getElementById('activityList');
            if (activity && stats.largest_files) {
                const header = document.createElement('div');
                header.className = 'text-sm text-slate-300 mb-2 font-medium';
                header.textContent = 'Top files by size:';
                const list = document.createElement('div');
                list.className = 'space-y-2';
                stats.largest_files.slice(0,4).forEach(f => {
                    const el = document.createElement('div');
                    el.className = 'flex flex-col text-[11px] text-slate-400';
                    el.innerHTML = `<div class="font-semibold text-slate-200 truncate">${f.name}</div><div class="text-[10px] text-slate-500">${humanSize(f.size)}</div>`;
                    list.appendChild(el);
                });
                // remove previous top-files node if present
                const existing = document.getElementById('topFilesPreview');
                if (existing) existing.remove();
                const wrapper = document.createElement('div');
                wrapper.id = 'topFilesPreview';
                wrapper.appendChild(header);
                wrapper.appendChild(list);
                activity.prepend(wrapper);
            }
        }

        async function aiSearch() {
            const query = document.getElementById('aiSearchInput').value.trim();
            const src = document.getElementById('sourceFolder').value.trim();
            if (!src) { alert('Please select a source folder first'); return; }
            if (!query) { alert('Please enter a query'); return; }

            try {
                const res = await window.pywebview.api.query_ai(src, query);
                if (res && res.error) { alert('AI search error: ' + res.error); return; }

                let html = `
                    <div class="bg-background-dark rounded-xl border border-white/10 w-full max-w-2xl p-6">
                        <h3 class="text-lg font-bold mb-3">Search results for "${query}"</h3>`;

                if (!res.results || res.results.length === 0) {
                    html += '<p class="text-sm text-slate-400">No matches found.</p>';
                } else {
                    html += '<div class="space-y-3">';
                    res.results.forEach(r => {
                        html += `<div class="p-3 bg-white/3 rounded"><div class="text-sm font-medium text-slate-100 truncate">${r.name}</div><div class="text-xs text-slate-400 mt-1">${r.snippet || ''}</div><div class="text-[10px] text-slate-500 mt-2">${r.path}</div></div>`;
                    });
                    html += '</div>';
                }

                html += '<div class="mt-4 text-right"><button class="px-4 py-2 bg-primary text-white rounded" onclick="this.closest(\'.py-modal\').remove()">Close</button></div></div>';

                const modal = document.createElement('div');
                modal.className = 'py-modal fixed inset-0 z-50 bg-black/70 flex items-center justify-center p-4';
                modal.innerHTML = html;
                modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
                document.body.appendChild(modal);
            } catch (err) {
                console.error('AI search error', err);
                alert('AI search failed: ' + err);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            // restore theme if saved
            const t = localStorage.getItem('rishflow_theme');
            if (t) setTheme(t);
        });

        function openFullscreenPreview() {
            if (!selectedFile) {
                alert('Please select a file first');
                return;
            }
            
            // Create fullscreen modal
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 z-50 bg-black/80 flex items-center justify-center p-4';
            modal.onclick = (e) => {
                if (e.target === modal) modal.remove();
            };
            
            const previewArea = document.getElementById('previewArea');
            const iconMap = {
                'document': { icon: 'picture_as_pdf', color: 'text-red-400' },
                'image': { icon: 'image', color: 'text-blue-400' },
                'video': { icon: 'video_library', color: 'text-amber-400' },
                'archive': { icon: 'folder_zip', color: 'text-slate-400' }
            };
            
            const fileInfo = iconMap[selectedFile.type] || { icon: 'insert_drive_file', color: 'text-slate-400' };
            
            modal.innerHTML = `
                <div class="bg-background-dark rounded-xl border border-white/10 w-full max-w-2xl p-8 flex flex-col items-center gap-6">
                    <div class="flex items-center justify-between w-full">
                        <h2 class="text-2xl font-bold text-white">File Preview</h2>
                        <button onclick="this.closest('div').parentElement.remove()" class="text-slate-400 hover:text-white">
                            <span class="material-symbols-outlined">close</span>
                        </button>
                    </div>
                    <div class="flex flex-col items-center gap-4 w-full">
                        <span class="material-symbols-outlined text-8xl ${fileInfo.color}">${fileInfo.icon}</span>
                        <div class="text-center w-full">
                            <p class="text-xl font-semibold text-white">${selectedFile.name}</p>
                            <p class="text-sm text-slate-400 mt-2">Type: ${selectedFile.type}</p>
                            <p class="text-sm text-slate-500 mt-4">File ready for organization</p>
                        </div>
                    </div>
                    <button onclick="this.closest('div').parentElement.remove()" class="mt-4 px-6 py-2 bg-primary hover:bg-sky-500 text-white rounded-lg font-semibold transition-colors">
                        Close Preview
                    </button>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        async function startOrganizing() {
            const sourceFolder = document.getElementById('sourceFolder').value.trim();
            const destFolder = document.getElementById('destFolder').value.trim();
            const sortMode = document.querySelector('select').value;
            
            if (!sourceFolder || !destFolder) {
                alert('Please select both source and destination folders');
                return;
            }
            
            try {
                // disable start button until operation completes
                const startBtn = document.getElementById('startBtn');
                startBtn.disabled = true;
                startBtn.classList.add('opacity-60');

                const result = await window.pywebview.api.start_organizing(sourceFolder, destFolder, sortMode);
                if (result.error) {
                    alert('Error: ' + result.error);
                    startBtn.disabled = false;
                    startBtn.classList.remove('opacity-60');
                } else {
                    alert('ðŸš€ File organization started with ' + sortMode + ' mode!');
                }
            } catch (error) {
                console.error('Error starting organization:', error);
                alert('Error starting organization: ' + error);
                const startBtn = document.getElementById('startBtn');
                startBtn.disabled = false;
                startBtn.classList.remove('opacity-60');
            }
        }

        // Called from Python via webview.evaluate_js when organizing completes
        window.onOrganizeComplete = async function(sourcePath) {
            try {
                const resp = await window.pywebview.api.scan_source(sourcePath);
                const files = Array.isArray(resp) ? resp : (resp && resp.files) ? resp.files : [];
                populateQueue(files);
                const logs = await window.pywebview.api.get_logs();
                updateActivity(logs);

                // Refresh aggregated stats
                try {
                    const stats = await window.pywebview.api.get_folder_stats(sourcePath);
                    updateStatsPanel(stats);
                } catch (statErr) {
                    console.warn('Stats refresh error:', statErr);
                }
            } catch (e) {
                console.error('onOrganizeComplete error:', e);
            } finally {
                const startBtn = document.getElementById('startBtn');
                if (startBtn) {
                    startBtn.disabled = false;
                    startBtn.classList.remove('opacity-60');
                }
            }
        };

        // Called from Python when revert completes
        window.onRevertComplete = async function() {
            try {
                const src = document.getElementById('sourceFolder').value.trim();
                if (src) {
                    const resp = await window.pywebview.api.scan_source(src);
                    const files = Array.isArray(resp) ? resp : (resp && resp.files) ? resp.files : [];
                    populateQueue(files);

                    // Refresh aggregated stats
                    try {
                        const stats = await window.pywebview.api.get_folder_stats(src);
                        updateStatsPanel(stats);
                    } catch (statErr) {
                        console.warn('Stats refresh error:', statErr);
                    }
                }
                const logs = await window.pywebview.api.get_logs();
                updateActivity(logs);
            } catch (e) {
                console.error('onRevertComplete error:', e);
            }
        };

        function updateActivity(logs) {
            const container = document.getElementById('activityList');
            if (!container) return;
            container.innerHTML = '';
            if (!logs || logs.error) {
                container.innerHTML = '<div class="text-sm text-slate-400">No activity yet.</div>';
                return;
            }
            if (logs.length === 0) {
                container.innerHTML = '<div class="text-sm text-slate-400">No activity yet.</div>';
                return;
            }
            logs.forEach(l => {
                const el = document.createElement('div');
                el.className = 'flex gap-2 text-slate-400';
                const ts = document.createElement('span');
                ts.className = 'text-primary/70';
                ts.textContent = '[' + (l.timestamp || '') + ']';
                const msg = document.createElement('span');
                msg.className = 'flex-1';
                msg.textContent = `${l.action} ${l.source_file ? ' â€” ' + l.source_file : ''} ${l.destination ? ' â†’ ' + l.destination : ''} (${l.status || ''})`;
                el.appendChild(ts);
                el.appendChild(msg);
                container.appendChild(el);
            });
        }
    </script>

</body></html>